#!/bin/bash
# Odoco AP Config v2.0 - Solución Estable

# --- Configuración ---
AP_NAME="OdocoAP"
AP_SSID="Odoco"
AP_PASSWORD="Odoco2024"  # ¡Cambiar en producción!
AP_IP="192.168.4.1/24"
AP_CHANNEL="6"
DHCP_RANGE="192.168.4.2,192.168.4.100,255.255.255.0"

# --- 1. Detener servicios conflictivos ---
sudo systemctl stop dhcpcd dnsmasq hostapd
sudo systemctl mask dhcpcd dnsmasq hostapd
sudo systemctl enable --now NetworkManager

# --- 2. Limpiar configuraciones previas ---
sudo nmcli con del "$AP_NAME" 2>/dev/null
sudo ip addr flush dev wlan0
sudo rfkill unblock wlan

# --- 3. Configurar AP con NMCLI ---
sudo nmcli con add type wifi ifname wlan0 con-name "$AP_NAME" \
  ipv4.method manual ipv4.addresses "$AP_IP" \
  ipv4.gateway "$AP_IP%wlan0" \
  wifi.mode ap wifi.ssid "$AP_SSID" \
  wifi.band bg wifi.channel "$AP_CHANNEL" \
  wifi-sec.key-mgmt wpa-psk wifi-sec.psk "$AP_PASSWORD"

# --- 4. Configurar DHCP y DNS ---
sudo nmcli con modify "$AP_NAME" ipv4.dns "8.8.8.8,8.8.4.4"
sudo nmcli con modify "$AP_NAME" ipv4.dhcp-range "$DHCP_RANGE"

# --- 5. Configurar NAT ---
sudo iptables -t nat -F
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
sudo iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT

# --- 6. Hacer persistente la configuración ---
sudo sh -c "iptables-save > /etc/iptables.rules"
echo -e "[Service]\nExecStartPost=/sbin/iptables-restore /etc/iptables.rules" | sudo tee /etc/systemd/system/NetworkManager.service.d/10-iptables.conf

# --- 7. Reiniciar servicios ---
sudo systemctl daemon-reload
sudo systemctl restart NetworkManager
sudo nmcli con up "$AP_NAME"

echo -e "\n✔ Access Point configurado:"
echo -e "SSID: $AP_SSID"
echo -e "IP: $AP_IP"
echo -e "Cliente DHCP: $DHCP_RANGE"